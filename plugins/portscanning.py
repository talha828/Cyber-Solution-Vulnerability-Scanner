from utils.status import *
from .helper import Plugin, utils
import socket
import json
import sys

class PortScanner(Plugin):
    def __init__(self):
        self.name = "Port Scanner"
        self.enable = True
        self.description = "Scans for open ports on a given host"
        self.ports_to_scan = json.loads(open(sys.path[0] + "/plugins/files/ports.json", "r").read())

    def presquites(self, host):
        if utils.isalive(utils.uri(host)):
            return True
        return False

    def scan_port(self, host, port):
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)
            result = sock.connect_ex((host, port))
            sock.close()
            return result == 0
        except:
            return False

    def vuln(self, host):
        open_ports = []
        for port in self.ports_to_scan:
            if self.scan_port(host, port):
                open_ports.append(port)
        return open_ports if open_ports else None

    def main(self, host):
        try:
            result = self.vuln(host)
        except:
            result = None

        if not result:
            return Result(FAILED, None, None, None)

        return Result(
            status=SUCCESS,
            msg=result,
            request=None,
            response=None
        )
